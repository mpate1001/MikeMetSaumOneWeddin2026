name: Sync Zola RSVP Data

on:
  # Run daily at 8 AM UTC (3 AM EST / 12 AM PST)
  schedule:
    - cron: '0 8 * * *'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Run mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - retry-failed

permissions:
  contents: write
  issues: write

jobs:
  sync-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium

      - name: Restore Zola session
        env:
          ZOLA_SESSION: ${{ secrets.ZOLA_SESSION }}
        run: |
          mkdir -p data
          echo "$ZOLA_SESSION" | base64 -d > data/.zola_session.json

      - name: Scrape Zola guest data (Full Run)
        if: ${{ github.event.inputs.run_mode != 'retry-failed' }}
        env:
          USPS_USER_ID: ${{ secrets.USPS_USER_ID }}
        run: |
          echo "Running FULL scrape..."
          if [ -n "$USPS_USER_ID" ]; then
            echo "USPS address validation enabled"
          else
            echo "USPS address validation disabled (no USPS_USER_ID secret)"
          fi
          python scripts/scrape_zola_guests.py --headless --keep-open 0

      - name: Scrape Zola guest data (Retry Failed)
        if: ${{ github.event.inputs.run_mode == 'retry-failed' }}
        env:
          USPS_USER_ID: ${{ secrets.USPS_USER_ID }}
        run: |
          echo "Running RETRY-FAILED scrape..."
          python scripts/scrape_zola_guests.py --headless --keep-open 0 --from-failed-log

      - name: Copy latest data to dashboard
        run: |
          # Find the latest non-partial CSV file
          LATEST_CSV=$(ls -t data/scraped/zola_guests_*.csv | grep -v partial | head -1)
          echo "Latest CSV: $LATEST_CSV"
          cp "$LATEST_CSV" site/public/data.csv
          echo "Copied to site/public/data.csv"

      - name: Check for failed guests
        id: check_failures
        run: |
          # Find the most recent failed_guests file
          FAILED_LOG=$(ls -t data/scraped/failed_guests_*.json 2>/dev/null | head -1 || true)
          if [ -n "$FAILED_LOG" ] && [ -f "$FAILED_LOG" ]; then
            FAILED_COUNT=$(python -c "import json; print(len(json.load(open('$FAILED_LOG')).get('guests', [])))")
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
            echo "failed_log=$FAILED_LOG" >> $GITHUB_OUTPUT
            echo "Found $FAILED_COUNT failed guests in $FAILED_LOG"
          else
            echo "failed_count=0" >> $GITHUB_OUTPUT
            echo "No failed guests log found"
          fi

      - name: Check for changes
        id: changes
        run: |
          git add data/scraped/ site/public/data.csv
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/scraped/ site/public/data.csv

          # Different commit messages for different run modes
          if [ "${{ github.event.inputs.run_mode }}" == "retry-failed" ]; then
            git commit -m "Update RSVP data (retry-failed) - $(date +'%Y-%m-%d')"
          else
            git commit -m "Update RSVP data - $(date +'%Y-%m-%d')"
          fi

          git pull --rebase origin main
          git push

      - name: Create issue for failed guests
        if: steps.check_failures.outputs.failed_count > 0 && github.event.inputs.run_mode != 'retry-failed'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failedLog = '${{ steps.check_failures.outputs.failed_log }}';
            const failedData = JSON.parse(fs.readFileSync(failedLog, 'utf8'));
            const failedCount = failedData.guests.length;

            // Build the issue body
            let body = `## RSVP Scrape Alert\n\n`;
            body += `**${failedCount} guest(s) failed to scrape** on ${new Date().toISOString().split('T')[0]}.\n\n`;
            body += `### Failed Guests\n\n`;

            for (const guest of failedData.guests) {
              body += `- **[${guest.index + 1}] ${guest.display_name}**: ${guest.reason} (${guest.attempts} attempts)\n`;
            }

            body += `\n### Next Steps\n\n`;
            body += `1. Go to **Actions** > **Sync Zola RSVP Data**\n`;
            body += `2. Click **Run workflow**\n`;
            body += `3. Select **retry-failed** from the dropdown\n`;
            body += `4. Click **Run workflow** button\n\n`;
            body += `This will re-scrape only the failed guests and merge them into the existing data.\n`;

            // Check if there's already an open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraper-alert'
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: body
              });
              console.log(`Updated existing issue #${existingIssues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ RSVP Scrape: ${failedCount} guest(s) failed`,
                body: body,
                labels: ['scraper-alert']
              });
              console.log('Created new issue for failed guests');
            }

      - name: Close issue if retry succeeded
        if: steps.check_failures.outputs.failed_count == 0 && github.event.inputs.run_mode == 'retry-failed'
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraper-alert'
            });

            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… All failed guests have been successfully re-scraped!'
              });

              console.log(`Closed issue #${issue.number}`);
            }

      - name: Upload artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: |
            error_screenshot.png
            debug_*.png
            data/screenshots/
          if-no-files-found: ignore
